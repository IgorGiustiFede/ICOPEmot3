<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéôÔ∏è</text></svg>" />
    <title>Record and Send Voice Memo</title>
</head>
<body style="display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0;">
    <div>
    <h2 style="display: none;">ICOPE</h2>
    <button id="recordBtn" class="record-button">
      <img src="https://github.com/IgorGiustiFede/ICOPE/raw/afd76fde9f3d8c10049c5501cb5670803ada72b2/image%20micro-modified.png" alt="Microphone" class="microphone-icon">
    </button>
    <audio id="audio" controls style="display: none;"></audio>
</div>

<style>
  .record-button {
    background-color: #4285f4;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .record-button.recording {
    background-color: #d32f2f;
  }

  .microphone-icon {
    width: 40px;
    height: 40px;
  }
</style>

<script>
  const recordBtn = document.getElementById('recordBtn');
  const audio = document.getElementById('audio');
  let recorder;
  let audioStream;
  let isRecording = false;

  function toggleRecording() {
    if (isRecording) {
      stopRecording();
    } else {
      startRecording();
    }
  }

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            audioStream = stream;
            recorder = new MediaRecorder(stream);
            const audioChunks = [];

            recorder.addEventListener('dataavailable', (event) => {
                audioChunks.push(event.data);
            });

            recorder.addEventListener('stop', () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                const fileName = generateFileName();
                sendAudioData(audioBlob, fileName);
                audioChunks.length = 0;
                isRecording = false;
                recordBtn.classList.remove('recording');
            });

            recorder.start();
            isRecording = true;
            recordBtn.classList.add('recording');
        })
        .catch(err => console.error(err));
  }

  function stopRecording() {
    recorder.stop();
    audioStream.getAudioTracks().forEach(track => track.stop());
  }

  function sendAudioData(data, fileName) {
    const serverUrl = "https://hook.eu1.make.com/1y1ku32ezig5rezo6ab995olarcijhcx";
    const formData = new FormData();
    formData.set('file', data, fileName);
    fetch(serverUrl, { method: "POST", body:  formData})
        .then(response => console.log(`Audio data (${fileName}) sent to server.`))
        .catch(error => console.error("Error sending audio data to server: ", error));
  }

  function generateFileName() {
    const date = new Date();
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const timestamp = date.getTime().toString();
    return `${year}-${month}-${day}-${timestamp}.mp3`;
  }

  recordBtn.addEventListener('click', toggleRecording);
</script>
</html>
